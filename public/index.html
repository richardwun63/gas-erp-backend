<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Gas ERP Ayacucho V5.x - Modular</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Estilos base -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/auth.css">
    <link rel="stylesheet" href="/css/buttons.css">
    <link rel="stylesheet" href="/css/cards.css">
    <link rel="stylesheet" href="/css/forms.css">
    <link rel="stylesheet" href="/css/modals.css">
    <link rel="stylesheet" href="/css/tables.css">
    <link rel="stylesheet" href="/css/tabs.css">
    <!-- Estilos específicos de roles -->
    <link rel="stylesheet" href="/css/roles/cliente.css">
    <link rel="stylesheet" href="/css/roles/repartidor.css">
    <link rel="stylesheet" href="/css/roles/base.css">
    <link rel="stylesheet" href="/css/roles/contabilidad.css">
    <link rel="stylesheet" href="/css/roles/gerente.css">
    <!-- Librerías externas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Contenedores de Pantallas Principales -->
    <div id="login-screen" class="screen active">
        <div class="auth-container"></div>
    </div>

    <div id="register-screen" class="screen">
        <div class="auth-container"></div>
    </div>

    <div id="app-container" class="app-container-hidden">
        <header id="app-header">
            <div class="user-info">
                <img id="user-photo" src="/assets/placeholder-user.png" alt="Foto Usuario" class="user-photo">
                <div class="user-details">
                    <span id="user-name-display" class="user-name">Usuario</span>
                    <span id="user-role-display" class="user-role">Rol</span>
                </div>
            </div>
            <nav>
                <div id="warehouse-selector-header" class="warehouse-selector" style="display: none;">
                    <i class="fas fa-warehouse"></i>
                    <select id="global-warehouse-select" name="global_warehouse_id">
                        <option value="">Cargando...</option>
                    </select>
                    <span id="current-warehouse-name-display" class="current-warehouse-name" style="display: none;"></span>
                </div>
                <button id="logout-button" class="btn btn-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </nav>
        </header>

        <main id="main-content">
            <div class="loading-placeholder">
                <i class="fas fa-spinner fa-spin"></i> Cargando interfaz...
            </div>
        </main>

        <footer id="app-footer">
            <p>&copy; <span id="current-year">2024</span> Gas ERP Ayacucho. Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- TEMPLATES DE ROLES -->
    <!-- Template Cliente -->
    <template id="cliente-dashboard">
        <div class="dashboard cliente-dashboard">
            <h2><i class="fas fa-user"></i> Mi Panel de Cliente</h2>
            <div class="grid-container-responsive">
                <!-- Tarjeta Puntos y Referidos -->
                <div class="card">
                    <h3><i class="fas fa-star"></i> Mis Puntos y Referidos</h3>
                    <p>Puntos Acumulados: <span id="cliente-puntos" class="highlight">0</span></p>
                    <div id="benefits-description" style="margin-bottom: 10px; font-size: 0.9em; color: var(--text-muted);">Cargando beneficios...</div>
                    <button class="btn btn-info btn-sm" onclick="showBenefitsModal()">Ver Beneficios</button>
                    <hr>
                    <p>Mi Código de Referido:</p>
                    <div class="referral-code-box">
                        <strong id="cliente-ref-code">CARGANDO...</strong>
                        <button class="btn btn-secondary btn-sm" onclick="copyReferralCode()"><i class="fas fa-copy"></i> Copiar</button>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="shareReferralCode()"><i class="fas fa-share-alt"></i> Compartir Código</button>
                    <button id="btn-canjear-puntos" class="btn btn-primary btn-sm" onclick="redeemPointsHandler()"><i class="fas fa-gift"></i> Canjear Puntos</button>
                </div>
                
                <!-- Tarjeta Realizar Pedido -->
                <div class="card">
                    <h3><i class="fas fa-gas-pump"></i> Realizar Pedido</h3>
                    <form id="pedido-form">
                        <div class="input-group">
                            <label for="pedido-tipo-balon"><i class="fas fa-weight-hanging"></i> Tipo de Balón:</label>
                            <select id="pedido-tipo-balon" name="cylinder_type_id" required>
                                <option value="">Cargando...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="pedido-accion-balon"><i class="fas fa-exchange-alt"></i> Acción (Balón):</label>
                            <select id="pedido-accion-balon" name="action_type">
                                <option value="exchange" selected>Intercambio (Dejo balón vacío)</option>
                                <option value="new_purchase">Nuevo (Compro balón + gas)</option>
                                <option value="loan_purchase">Préstamo (Garantía + Gas)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="pedido-cantidad-balon"><i class="fas fa-sort-numeric-up"></i> Cantidad Balones:</label>
                            <input type="number" id="pedido-cantidad-balon" name="cylinder_quantity" value="1" min="0" max="5" onchange="updatePedidoPriceEstimate()">
                        </div>
                        <hr>
                        <h4><i class="fas fa-box-open"></i> Otros Productos (Opcional)</h4>
                        <div id="otros-productos-list" class="item-list-simple" style="max-height: 150px; margin-bottom: 15px;">
                            <p>Cargando productos...</p>
                        </div>
                        <hr>
                        <div class="input-group">
                            <label for="pedido-direccion"><i class="fas fa-map-marker-alt"></i> Dirección de Entrega:</label>
                            <textarea id="pedido-direccion" name="delivery_address_text" rows="2" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="delivery_instructions"><i class="fas fa-sticky-note"></i> Instrucciones (Opcional):</label>
                            <textarea id="delivery_instructions" name="delivery_instructions" rows="2" placeholder="Ej: Dejar en portería, llamar antes..."></textarea>
                        </div>
                        <div class="price-estimate">
                            Precio Estimado: <span id="pedido-precio-estimado" class="highlight">S/ 0.00</span>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Enviar Pedido</button>
                        <div id="pedido-status" class="status-message"></div>
                    </form>
                </div>
                
                <!-- Tarjeta Historial de Pedidos -->
                <div class="card card-full-width">
                    <h3><i class="fas fa-history"></i> Historial de Pedidos</h3>
                    <div class="table-responsive">
                        <table class="table" id="cliente-historial-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>ID</th>
                                    <th>Estado</th>
                                    <th>Monto</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tarjeta Pagos y Recibos -->
                <div class="card">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Pagos y Recibos</h3>
                    <p>Estado del último pago: <span id="pago-estado" class="status-tag status-pending">Pendiente</span></p>
                    <div class="input-group">
                        <label for="payment-proof-input"><i class="fas fa-camera"></i> Adjuntar Constancia (Yape/Plin/Otros):</label>
                        <input type="file" id="payment-proof-input" accept="image/*,application/pdf">
                        <img id="comprobante-preview" src="#" alt="Vista previa" class="comprobante-preview"/>
                    </div>
                    <button class="btn btn-info" id="btn-subir-comprobante" onclick="uploadPaymentProof()"><i class="fas fa-upload"></i> Subir Comprobante</button>
                    <div id="upload-status" class="status-message"></div>
                    <h4>Mis Recibos/Facturas:</h4>
                    <div id="cliente-recibos-list" class="item-list-simple">
                        <p>No tienes recibos disponibles.</p>
                    </div>
                </div>
                
                <!-- Tarjeta Mis Datos -->
                <div class="card">
                    <h3><i class="fas fa-user-edit"></i> Mis Datos</h3>
                    <div id="cliente-profile-summary">
                        <p><i class="fas fa-id-card"></i> <span id="cliente-data-nombre">Cargando...</span></p>
                        <p><i class="fas fa-hashtag"></i> <span id="cliente-data-dni">Cargando...</span></p>
                        <p><i class="fas fa-mobile-alt"></i> <span id="cliente-data-celular">Cargando...</span></p>
                        <p><i class="fas fa-map-marker-alt"></i> <span id="cliente-data-direccion">Cargando...</span></p>
                    </div>
                    <button class="btn btn-secondary btn-sm" id="btn-editar-perfil" onclick="openEditProfileModal()"><i class="fas fa-edit"></i> Editar Mis Datos</button>
                    <button id="request-maintenance-btn" class="btn btn-warning btn-sm" onclick="requestFreeMaintenance()"><i class="fas fa-tools"></i> Solicitar Mantenimiento</button>
                    <button id="whatsapp-contact-btn" class="btn btn-success btn-sm" onclick="openWhatsApp()"><i class="fab fa-whatsapp"></i> Contactar por WhatsApp</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Template Repartidor -->
    <template id="repartidor-dashboard">
        <div class="dashboard repartidor-dashboard">
            <h2><i class="fas fa-motorcycle"></i> Panel de Repartidor</h2>
            <div id="repartidor-status-banner" class="status-message info">
                <i class="fas fa-info-circle"></i> Estado: <span id="repartidor-status-text">Conectando...</span>
            </div>
            
            <!-- Entrega Actual Asignada -->
            <div id="asignacion-actual" class="card card-highlight" style="display: none;">
                <h3><i class="fas fa-map-marked-alt"></i> Próxima Entrega Asignada</h3>
                <div class="delivery-details">
                    <p><strong><i class="fas fa-hashtag"></i> Pedido ID:</strong> <span id="rep-order-id"></span></p>
                    <p><strong><i class="fas fa-user"></i> Cliente:</strong> <span id="rep-cliente-nombre"></span></p>
                    <p><strong><i class="fas fa-map-marker-alt"></i> Dirección:</strong> <span id="rep-cliente-direccion"></span></p>
                    <p><strong><i class="fas fa-gas-pump"></i> Pedido:</strong> <span id="rep-pedido-detalle"></span></p>
                    <p><strong><i class="fas fa-mobile-alt"></i> Celular:</strong> <a href="#" id="rep-cliente-celular-link"><span id="rep-cliente-celular"></span> <i class="fas fa-phone-alt"></i></a></p>
                    <p><strong><i class="far fa-clock"></i> Asignado hace:</strong> <span id="rep-tiempo-asignado">0 min</span></p>
                    <p><strong><i class="fas fa-sticky-note"></i> Instrucciones:</strong> <span id="rep-instrucciones">Ninguna</span></p>
                </div>
                <div class="delivery-actions">
                    <button id="rep-map-button" class="btn btn-primary" onclick="openMap(document.getElementById('rep-cliente-direccion').textContent)"><i class="fas fa-directions"></i> Abrir Mapa</button>
                    <button id="rep-start-button" class="btn btn-warning" onclick="startDelivery()"><i class="fas fa-play-circle"></i> Iniciar Entrega</button>
                </div>
                
                <!-- Formulario Completar Entrega -->
                <form id="complete-delivery-form" style="display: none; margin-top:15px;">
                    <hr>
                    <h4><i class="fas fa-dollar-sign"></i> Registro de Entrega y Cobro</h4>
                    <input type="hidden" id="complete-order-id" name="orderId">
                    <div class="input-group">
                        <label for="rep-metodo-cobro"><i class="fas fa-money-bill-wave"></i> Método de Cobro:</label>
                        <select id="rep-metodo-cobro" name="collection_method" required>
                            <option value="cash" selected>Efectivo</option>
                            <option value="yape_plin">Yape/Plin</option>
                            <option value="transfer">Transferencia</option>
                            <option value="cobro_pendiente">Cobro Pendiente (Agendar Hora)</option>
                            <option value="not_collected">No se pudo Cobrar</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="rep-monto-cobrado"><i class="fas fa-cash-register"></i> Monto Cobrado (si aplica):</label>
                        <input type="number" id="rep-monto-cobrado" name="amount_collected" step="0.10" placeholder="Ej: 48.50">
                    </div>
                    <div id="schedule-collection-section" class="input-group" style="display: none;">
                        <input type="checkbox" id="schedule-collection-cb" name="schedule_later">
                        <label for="schedule-collection-cb" style="display: inline-block; margin-left: 5px;">Agendar hora para regresar a cobrar</label>
                        <input type="time" id="scheduled-collection-time-input" name="scheduled_collection_time" style="display: none; margin-top: 5px;">
                    </div>
                    <div class="input-group">
                        <label for="rep-payment-proof"><i class="fas fa-camera"></i> Adjuntar Foto Constancia (Opcional):</label>
                        <input type="file" id="rep-payment-proof" name="paymentProof" accept="image/*">
                        <img id="rep-comprobante-preview" src="#" alt="Vista previa" class="comprobante-preview"/>
                    </div>
                    <div class="input-group">
                        <label for="rep-entrega-notas"><i class="fas fa-comment-dots"></i> Notas de Entrega (Opcional):</label>
                        <textarea id="rep-entrega-notas" name="delivery_notes" rows="2" placeholder="Ej: Cliente no estaba, se dejó con vecino, etc."></textarea>
                    </div>
                    <input type="hidden" id="delivery-has-issue" name="has_issue" value="false">
                    <button type="submit" class="btn btn-success"><i class="fas fa-check-circle"></i> Marcar como Entregado</button>
                    <button type="button" class="btn btn-danger" onclick="reportIssue(event)"><i class="fas fa-exclamation-triangle"></i> Reportar Problema</button>
                    <div id="complete-delivery-error" class="error-message"></div>
                </form>
                
                <!-- Formulario Reporte de Problema -->
                <form id="report-issue-form" style="display: none; margin-top: 15px;">
                    <hr>
                    <h4><i class="fas fa-exclamation-triangle"></i> Reportar Problema</h4>
                    <div class="input-group">
                        <label for="issue-notes">Describe el problema:</label>
                        <textarea id="issue-notes" name="issue_notes" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-warning">Enviar Reporte de Problema</button>
                    <div id="report-issue-error" class="error-message"></div>
                </form>
            </div>
            
            <!-- Sin Asignación -->
            <div id="sin-asignacion" class="card text-center" style="display: none;">
                <h3><i class="fas fa-pause-circle"></i> Esperando Asignación</h3>
                <p>Se te notificará cuando tengas un nuevo pedido.</p>
                <button class="btn btn-info" onclick="loadRepartidorPedidosDisponibles()"><i class="fas fa-list"></i> Ver Pedidos Disponibles</button>
                <div id="pedidos-disponibles-list" class="item-list" style="margin-top: 15px;">
                    <p>Cargando...</p>
                </div>
            </div>
            
            <!-- Entregas del Día -->
            <div class="card card-full-width">
                <h3><i class="fas fa-history"></i> Entregas del Día</h3>
                <div class="table-responsive">
                    <table class="table" id="rep-historial-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Cliente</th>
                                <th>Estado Ped.</th>
                                <th>Método Cobro</th>
                                <th>Monto Cobrado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Cuadre de Caja -->
            <div class="card">
                <h3><i class="fas fa-cash-register"></i> Cuadre de Caja (Hoy)</h3>
                <div id="rep-cuadre-resumen">
                    <p>Cargando resumen...</p>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="viewDetailedCashReport()"><i class="fas fa-search-dollar"></i> Ver Detalle</button>
            </div>
        </div>
    </template>

    <!-- Template Base -->
    <template id="base-dashboard">
        <div class="dashboard base-dashboard">
            <h2><i class="fas fa-headset"></i> Panel Central de Operaciones</h2>
            <div class="grid-container-dynamic">
                <!-- Pedidos Pendientes -->
                <div class="card">
                    <h3><i class="fas fa-inbox"></i> Pedidos Pendientes <span class="badge" id="base-pedidos-count">0</span></h3>
                    <div id="base-pedidos-pendientes-list" class="item-list-detailed">
                        <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando pedidos...</div>
                    </div>
                </div>
                
                <!-- Estado Repartidores -->
                <div class="card">
                    <h3><i class="fas fa-motorcycle"></i> Estado Repartidores</h3>
                    <div id="base-repartidores-estado-list" class="item-list">
                        <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Actualizando estado...</div>
                    </div>
                </div>
                
                <!-- Stock -->
                <div class="card">
                    <h3><i class="fas fa-cubes"></i> Stock <span id="base-stock-warehouse-name">(Principal)</span></h3>
                    <ul id="base-stock-list" class="stock-list">
                        <li><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando stock...</div></li>
                    </ul>
                    <div id="base-stock-list-total" class="stock-list-total" style="display: none;">Total Llenos: <span id="base-total-llenos">0</span></div>
                </div>
                
                <!-- Seguimiento Pedidos Activos -->
                <div class="card card-full-width">
                    <h3><i class="fas fa-tasks"></i> Seguimiento Pedidos Activos</h3>
                    <div class="table-responsive">
                        <table class="table" id="base-pedidos-activos-table">
                            <thead>
                                <tr>
                                    <th>ID Pedido</th>
                                    <th>Cliente</th>
                                    <th>Repartidor</th>
                                    <th>Estado</th>
                                    <th>Tiempo</th>
                                    <th>Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando seguimiento...</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Cobros Pendientes -->
                <div class="card">
                    <h3><i class="fas fa-hand-holding-usd"></i> Cobros Pendientes (General)</h3>
                    <div id="base-cobros-pendientes-list" class="item-list-detailed">
                        <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando cobros...</div>
                    </div>
                </div>
                
                <!-- Próximos Cumpleaños -->
                <div class="card">
                    <h3><i class="fas fa-birthday-cake"></i> Próximos Cumpleaños (Clientes)</h3>
                    <ul id="base-birthday-list" class="item-list-simple">
                        <li><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando...</div></li>
                    </ul>
                    <button class="btn btn-info btn-sm" onclick="viewCustomerList()"><i class="fas fa-users"></i> Ver Lista Clientes</button>
                </div>
                
                <!-- Comunicación Rápida -->
                <div class="card">
                    <h3><i class="fas fa-comments"></i> Comunicación Rápida</h3>
                    <div class="input-group">
                        <label for="base-chat-target">Enviar a:</label>
                        <select id="base-chat-target">
                            <option value="all-repartidores">Todos los Repartidores</option>
                        </select>
                    </div>
                    <textarea id="base-chat-message" placeholder="Escribe un mensaje corto..." rows="2"></textarea>
                    <button class="btn btn-primary btn-sm" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i> Enviar</button>
                </div>
                
                <!-- Ajustar Puntos Cliente -->
                <div class="card">
                    <h3><i class="fas fa-star"></i> Ajustar Puntos Cliente</h3>
                    <button class="btn btn-secondary" onclick="adjustPoints()"><i class="fas fa-edit"></i> Abrir Modal Ajuste</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Template Contabilidad -->
    <template id="contabilidad-dashboard">
        <div class="dashboard contabilidad-dashboard">
            <h2><i class="fas fa-calculator"></i> Panel de Contabilidad y Finanzas</h2>
            
            <!-- Navegación por pestañas -->
            <div class="tab-nav">
                <button class="tab-link active" onclick="openTab(event, 'conta-resumen')"><i class="fas fa-chart-line"></i> Resumen</button>
                <button class="tab-link" onclick="openTab(event, 'conta-recibos')"><i class="fas fa-receipt"></i> Recibos/Facturas</button>
                <button class="tab-link" onclick="openTab(event, 'conta-pagos')"><i class="fas fa-check-double"></i> Verificación Pagos</button>
                <button class="tab-link" onclick="openTab(event, 'conta-morosos')"><i class="fas fa-user-clock"></i> Clientes Morosos</button>
                <button class="tab-link" onclick="openTab(event, 'conta-inventario')"><i class="fas fa-boxes"></i> Inventario Det.</button>
                <button class="tab-link" onclick="openTab(event, 'conta-cuadres')"><i class="fas fa-balance-scale-right"></i> Cuadres Caja</button>
                <button class="tab-link" onclick="openTab(event, 'conta-reportes')"><i class="fas fa-file-alt"></i> Reportes</button>
            </div>
            
            <!-- Contenido Resumen -->
            <div id="conta-resumen" class="tab-content active">
                <h3>Resumen Financiero del Día (<span id="conta-current-date"></span>)</h3>
                <div class="grid-container-kpi" id="conta-kpi-resumen">
                    <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando resumen...</div>
                </div>
                <h4>Tendencia de Ingresos (Últimos 7 Días)</h4>
                <canvas id="conta-income-chart" style="max-height: 250px;"></canvas>
            </div>
            
            <!-- Contenido Recibos/Facturas -->
            <div id="conta-recibos" class="tab-content">
                <h3>Adjuntar Recibos / Facturas a Pedidos</h3>
                <div class="toolbar">
                    <input type="text" id="conta-search-order-input" placeholder="Buscar por ID Pedido, Cliente, DNI/RUC...">
                    <button id="find-order-receipt-btn" class="btn btn-secondary"><i class="fas fa-search"></i> Buscar Pedido</button>
                </div>
                <div id="conta-pedido-encontrado-recibo" class="card" style="display:none;">
                    <h4>Pedido Encontrado</h4>
                    <p>ID: <strong id="receipt-order-id"></strong></p>
                    <p>Cliente: <span id="receipt-customer-name"></span> (<span id="receipt-customer-doc"></span>)</p>
                    <p>Fecha: <span id="receipt-order-date"></span> | Monto: S/ <span id="receipt-order-amount"></span></p>
                    <div class="input-group">
                        <label for="receipt-file-input"><i class="fas fa-file-pdf"></i> Adjuntar Recibo/Factura (PDF):</label>
                        <input type="file" id="receipt-file-input" name="receiptFile" accept="application/pdf" required>
                    </div>
                    <button id="upload-receipt-btn" class="btn btn-primary"><i class="fas fa-upload"></i> Subir y Asociar</button>
                    <div id="conta-upload-status" class="status-message"></div>
                </div>
                <hr>
                <h4>Recibos Subidos Recientemente</h4>
                <div class="table-responsive">
                    <table class="table" id="conta-recibos-subidos-table">
                        <thead><tr><th>Pedido ID</th><th>Cliente</th><th>Fecha Subida</th><th>Acción</th></tr></thead>
                        <tbody><tr><td colspan="4"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando...</div></td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Contenido Verificación Pagos -->
            <div id="conta-pagos" class="tab-content">
                <h3>Verificación de Pagos Reportados por Clientes/Repartidores</h3>
                <div class="table-responsive">
                    <table class="table" id="conta-pagos-verificar-table">
                        <thead>
                            <tr>
                                <th>ID Pago</th>
                                <th>Pedido ID</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>Método</th>
                                <th>Fecha Rep.</th>
                                <th>Constancia</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando pagos...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Contenido Clientes Morosos -->
            <div id="conta-morosos" class="tab-content">
                <h3>Reporte de Clientes Morosos (Pagos Pendientes > 3 días)</h3>
                <div class="table-responsive">
                    <table class="table" id="conta-morosos-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Celular</th>
                                <th>Pedido(s)</th>
                                <th>Monto Total</th>
                                <th>Días Mora</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando morosos...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Contenido Inventario -->
            <div id="conta-inventario" class="tab-content">
                <h3>Detalle de Inventario por Almacén</h3>
                <div class="toolbar">
                    <select id="conta-inventario-warehouse-select" name="warehouse_id" class="warehouse-selector-inline" onchange="loadContaInventarioDetalle()">
                        <option value="">-- Seleccione Almacén --</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadContaInventarioDetalle()"><i class="fas fa-refresh"></i> Actualizar</button>
                </div>
                <div class="table-responsive">
                    <table class="table" id="conta-inventario-detalle-table">
                        <thead>
                            <tr>
                                <th>Tipo Item</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Cantidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="4"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando inventario...</div></td></tr>
                        </tbody>
                        <tfoot style="display: none;">
                            <tr class="table-totals">
                                <th colspan="3">TOTAL BALONES FÍSICOS:</th>
                                <td id="conta-total-balones">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <h4>Log de Movimientos Recientes (Almacén Seleccionado)</h4>
                <div class="table-responsive">
                    <table class="table" id="conta-inventory-log-table">
                        <thead><tr><th>Fecha</th><th>Item</th><th>Cambio</th><th>Tipo Trans.</th><th>Usuario</th><th>Notas</th></tr></thead>
                        <tbody><tr><td colspan="6"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando log...</div></td></tr></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Contenido Cuadres de Caja -->
            <div id="conta-cuadres" class="tab-content">
                <h3>Cuadres de Caja Diarios (Repartidores)</h3>
                <div class="toolbar">
                    <label for="conta-cuadre-date">Fecha:</label>
                    <input type="date" id="conta-cuadre-date">
                    <button class="btn btn-secondary" onclick="loadContaCuadresRepartidores()"><i class="fas fa-search"></i> Buscar Cuadres</button>
                </div>
                <div class="table-responsive">
                    <table class="table" id="conta-cuadres-table">
                        <thead>
                            <tr>
                                <th>Repartidor</th>
                                <th>Entregas</th>
                                <th>Cobrado Efectivo</th>
                                <th>Cobrado Digital</th>
                                <th>Pendiente Cobro</th>
                                <th>Total Esperado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando cuadres...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Contenido Reportes -->
            <div id="conta-reportes" class="tab-content">
                <h3>Generación de Reportes Contables</h3>
                <div class="report-options card">
                    <div class="input-group">
                        <label for="report-type">Tipo de Reporte:</label>
                        <select id="report-type">
                            <option value="sales">Reporte de Ventas</option>
                            <option value="reconciliation">Conciliación de Caja</option>
                            <option value="overdue">Pagos Atrasados (Morosos)</option>
                            <option value="stock_levels">Niveles de Stock</option>
                            <option value="points_usage">Uso de Puntos Fidelidad</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="report-start-date">Fecha Inicio:</label>
                        <input type="date" id="report-start-date" required>
                    </div>
                    <div class="input-group">
                        <label for="report-end-date">Fecha Fin:</label>
                        <input type="date" id="report-end-date" required>
                    </div>
                    <div class="input-group" id="report-repartidor-filter" style="display: none;">
                        <label for="report-repartidor-id">Repartidor:</label>
                        <select id="report-repartidor-id">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <button id="generate-report-btn" class="btn btn-primary" onclick="generateReport()"><i class="fas fa-cogs"></i> Generar Reporte</button>
                </div>
                <div id="report-output" class="card" style="margin-top: 20px; display: none;">
                    <button class="close-button" onclick="document.getElementById('report-output').style.display='none'">&times;</button>
                    <h4 id="report-title">Resultado del Reporte</h4>
                    <div id="report-content" class="table-responsive">
                    </div>
                    <button id="download-report-btn" class="btn btn-secondary btn-sm" onclick="downloadReport()"><i class="fas fa-download"></i> Descargar</button>
                </div>
            </div>
        </div>
    </template>

    <!-- Template Gerente -->
    <template id="gerente-dashboard">
        <div class="dashboard gerente-dashboard">
            <h2><i class="fas fa-chart-line"></i> Dashboard Gerente</h2>
            
            <!-- Navegación por pestañas -->
            <div class="tab-nav">
                <button class="tab-link active" onclick="openTab(event, 'tab-kpis')"><i class="fas fa-tachometer-alt"></i> KPIs</button>
                <button class="tab-link" onclick="openTab(event, 'tab-clientes')"><i class="fas fa-users"></i> Clientes</button>
                <button class="tab-link" onclick="openTab(event, 'tab-empleados')"><i class="fas fa-user-tie"></i> Empleados</button>
                <button class="tab-link" onclick="openTab(event, 'tab-inventario')"><i class="fas fa-boxes"></i> Inventario</button>
                <button class="tab-link" onclick="openTab(event, 'tab-configuracion')"><i class="fas fa-cog"></i> Configuración</button>
            </div>
            
            <!-- Contenido KPIs -->
            <div id="tab-kpis" class="tab-content active">
                <div class="grid-container-kpi" id="kpi-container">
                    <div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando KPIs...</div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-chart-bar"></i> Ventas Mensuales</h3>
                    <canvas id="monthly-sales-chart"></canvas>
                </div>
            </div>
            
            <!-- Contenido Clientes -->
            <div id="tab-clientes" class="tab-content">
                <div class="toolbar">
                    <input type="text" id="cliente-search" placeholder="Buscar cliente..." class="search-input">
                    <button class="btn btn-secondary" onclick="loadGerenteClientes()"><i class="fas fa-refresh"></i> Actualizar</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-users"></i> Listado de Clientes</h3>
                    <div class="table-responsive">
                        <table class="table" id="clientes-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Teléfono</th>
                                    <th>Tipo</th>
                                    <th>Puntos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando clientes...</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Empleados -->
            <div id="tab-empleados" class="tab-content">
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="openCreateUserModal()"><i class="fas fa-user-plus"></i> Crear Empleado</button>
                    <button class="btn btn-info" onclick="manageRepartidorSchedules()"><i class="fas fa-calendar-alt"></i> Horarios Repartidores</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-user-tie"></i> Listado de Empleados</h3>
                    <div class="table-responsive">
                        <table class="table" id="empleados-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Usuario</th>
                                    <th>Rol</th>
                                    <th>Teléfono</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7"><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando empleados...</div></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Inventario -->
            <div id="tab-inventario" class="tab-content">
                <div class="toolbar">
                    <select id="inventario-warehouse-selector" name="warehouse_id" class="warehouse-selector-inline" onchange="loadGerenteInventarioData()">
                        <option value="">-- Seleccione Almacén --</option>
                    </select>
                    <button class="btn btn-warning" onclick="markAsDamaged()"><i class="fas fa-exclamation-triangle"></i> Reportar Dañado</button>
                    <button class="btn btn-secondary" onclick="manageOtherProducts()"><i class="fas fa-boxes"></i> Gestionar Otros Productos</button>
                </div>
                <div class="grid-container-responsive">
                    <div class="card">
                        <h3><i class="fas fa-fire-flame-curved"></i> Inventario de Balones</h3>
                        <ul class="stock-list" id="stock-list-balones">
                            <li><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando inventario...</div></li>
                        </ul>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-box"></i> Otros Productos</h3>
                        <ul class="stock-list" id="stock-list-otros">
                            <li><div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Cargando inventario...</div></li>
                        </ul>
                    </div>
                    <div class="card card-highlight">
                        <h3><i class="fas fa-truck-loading"></i> Préstamos Proveedor</h3>
                        <form id="prestamo-proveedor-form">
                            <div class="input-group">
                                <label for="prestamo-tipo">Tipo:</label>
                                <select id="prestamo-tipo" name="cylinder_type_id" required>
                                    <option value="">-- Seleccione --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="prestamo-cantidad">Cantidad:</label>
                                <input type="number" id="prestamo-cantidad" name="quantity" min="1" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Registrar Préstamo</button>
                        </form>
                        <hr>
                        <h4>Préstamos Activos:</h4>
                        <ul class="item-list-simple" id="prestamos-activos">
                            <li>No hay préstamos activos</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Configuración -->
            <div id="tab-configuracion" class="tab-content">
                <div class="grid-container-responsive">
                    <div class="card">
                        <h3><i class="fas fa-warehouse"></i> Almacenes</h3>
                        <button class="btn btn-primary" onclick="manageWarehouses()"><i class="fas fa-warehouse"></i> Gestionar Almacenes</button>
                    </div>
                    <div class="card">
                        <h3><i class="fab fa-whatsapp"></i> Configuración WhatsApp</h3>
                        <div class="config-section">
                            <label for="whatsapp-number">Número:</label>
                            <input type="tel" id="whatsapp-number" name="whatsapp_number" placeholder="Ej. 51999999999">
                            <button class="btn btn-primary" onclick="saveWhatsAppConfig()">Guardar</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-star"></i> Sistema de Puntos</h3>
                        <div class="config-section">
                            <label for="puntos-texto">Descripción:</label>
                            <textarea id="puntos-texto" rows="3" placeholder="Descripción de beneficios"></textarea>
                            <br>
                            <label for="puntos-ratio">Ratio:</label>
                            <input type="number" id="puntos-ratio" min="1" max="100" placeholder="Puntos por S/ 100">
                            <br>
                            <label for="puntos-minimo">Mínimo:</label>
                            <input type="number" id="puntos-minimo" min="0" placeholder="Mínimo para canjear">
                            <br>
                            <label for="puntos-descuento">Descuento S/:</label>
                            <input type="number" id="puntos-descuento" step="0.10" placeholder="Valor del descuento">
                            <br>
                            <button class="btn btn-primary" onclick="savePuntosConfig()">Guardar</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-file-export"></i> Reportes</h3>
                        <button class="btn btn-info" onclick="generateAdvancedReport()"><i class="fas fa-file-export"></i> Generar Reporte Avanzado</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- MODALES REUTILIZABLES -->
    <div id="benefits-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('benefits-modal')">&times;</span>
            <h2>Beneficios</h2>
            <p>Cargando...</p>
        </div>
    </div>
    
    <div id="assign-delivery-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="edit-customer-prices-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="view-details-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="create-user-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('create-user-modal')">×</span>
            <h2><i class="fas fa-user-plus"></i> Crear Empleado</h2>
            <form id="create-user-form-gerente">
                <div class="input-group"><label for="create-fullname">Nombre Completo:</label><input type="text" id="create-fullname" name="full_name" required></div>
                <div class="input-group"><label for="create-username">Username (Login):</label><input type="text" id="create-username" name="username" required></div>
                <div class="input-group"><label for="create-password">Contraseña Temporal:</label><input type="password" id="create-password" name="password" required></div>
                <div class="input-group">
                    <label for="create-role">Rol:</label>
                    <select id="create-role" name="role_name" required>
                        <option value="" disabled selected>-- Rol --</option>
                        <option value="repartidor">Repartidor</option>
                        <option value="base">Base</option>
                        <option value="contabilidad">Contabilidad</option>
                        <option value="gerente">Gerente</option>
                    </select>
                </div>
                <div class="input-group"><label for="create-phone">Celular Principal:</label><input type="tel" id="create-phone" name="phone_number_primary"></div>
                <div class="input-group">
                    <label for="create-warehouse">Almacén Predet.:</label>
                    <select id="create-warehouse" name="default_warehouse_id">
                        <option value="">-- Ninguno --</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Crear Empleado</button>
            </form>
            <div id="create-user-error" class="error-message"></div>
        </div>
    </div>
    
    <div id="edit-user-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="edit-schedule-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="warehouse-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="other-product-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="adjust-stock-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="adjust-points-modal" class="modal">
        <div class="modal-content"></div>
    </div>
    
    <div id="maintenance-request-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('maintenance-request-modal')">&times;</span>
            <h2><i class="fas fa-tools"></i> Solicitar Mantenimiento</h2>
            <form id="maintenance-request-form">
                <div class="input-group">
                    <label for="maintenance-notes">Descripción del problema:</label>
                    <textarea id="maintenance-notes" name="notes" rows="3" placeholder="Describa el problema o tipo de mantenimiento requerido..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
                <div id="maintenance-request-status" class="status-message"></div>
            </form>
        </div>
    </div>
    
    <div id="transfer-stock-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('transfer-stock-modal')">&times;</span>
            <h2><i class="fas fa-exchange-alt"></i> Transferir Stock</h2>
            <form id="transfer-stock-form">
                <div class="input-group">
                    <label for="transfer-source">Almacén Origen:</label>
                    <select id="transfer-source" name="source_warehouse_id" required></select>
                </div>
                <div class="input-group">
                    <label for="transfer-target">Almacén Destino:</label>
                    <select id="transfer-target" name="target_warehouse_id" required></select>
                </div>
                <div class="input-group">
                    <label for="transfer-item-type">Tipo de Item:</label>
                    <select id="transfer-item-type" name="item_type" required>
                        <option value="cylinder">Balón</option>
                        <option value="other_product">Otro Producto</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="transfer-item">Item:</label>
                    <select id="transfer-item" name="item_id" required></select>
                </div>
                <div class="input-group">
                    <label for="transfer-status">Estado:</label>
                    <select id="transfer-status" name="status" required></select>
                </div>
                <div class="input-group">
                    <label for="transfer-quantity">Cantidad:</label>
                    <input type="number" id="transfer-quantity" name="quantity" min="1" required>
                </div>
                <div class="input-group">
                    <label for="transfer-notes">Notas:</label>
                    <textarea id="transfer-notes" name="notes" rows="2"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Transferir</button>
                <div id="transfer-stock-status" class="status-message"></div>
            </form>
        </div>
    </div>
    
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('change-password-modal')">&times;</span>
            <h2><i class="fas fa-key"></i> Cambiar Contraseña</h2>
            <form id="change-password-form">
                <div class="input-group">
                    <label for="current-password">Contraseña Actual:</label>
                    <input type="password" id="current-password" name="currentPassword" required>
                </div>
                <div class="input-group">
                    <label for="new-password">Nueva Contraseña:</label>
                    <input type="password" id="new-password" name="newPassword" required minlength="6">
                </div>
                <div class="input-group">
                    <label for="confirm-new-password">Confirmar Nueva Contraseña:</label>
                    <input type="password" id="confirm-new-password" name="confirmNewPassword" required minlength="6">
                </div>
                <button type="submit" class="btn btn-primary">Cambiar Contraseña</button>
                <div id="change-password-status" class="status-message"></div>
            </form>
        </div>
    </div>
    
    <div id="global-notification" class="notification" style="display: none;">
        <div class="notification-content">
            <span class="notification-message">Mensaje de notificación</span>
            <span class="close-notification" onclick="document.getElementById('global-notification').style.display='none'">&times;</span>
        </div>
    </div>

    <!-- Script principal -->
    <script type="module" src="/js/main.js"></script>
</body>
</html>